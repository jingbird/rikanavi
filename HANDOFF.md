# りかナビ プロジェクト引継ぎドキュメント

**作成日**: 2024年12月2日  
**現在バージョン**: v1.16  
**次の作業**: チャットボット機能のバックエンド実装

---

## 📋 プロジェクト概要

**りかナビ** は、中学理科の学習を支援するWebアプリケーションです。

### 対象ユーザー
- 不登校などで学校に通えていない中学生
- 自分のペースで理科を学習したい生徒

### 主な機能
1. ✅ カリキュラム管理（中学1-3年、全46章）
2. ✅ 学習進捗管理（完了チェック、localStorage保存）
3. ✅ 動画検索（NHK for School API、YouTube、Web検索）
4. ✅ 確認テスト（4択、230問、難易度3段階、結果保存）
5. 🚧 チャットボット（学習ガイド）← **今ここ**

---

## ✅ 完成している機能

### v1.0-v1.13: 基本機能
- カリキュラムデータ統合（教科書LOD + 学習指導要領LOD）
- 学年・領域別の章表示
- 学習進捗管理（localStorage）
- NHK for School API連携
- YouTube・Web検索機能
- 学習目標の表示
- 使い方モーダル

### v1.14-v1.15: 確認テスト機能
- 全46章×5問=230問の4択問題を生成
- 難易度3段階（基礎2問、標準2問、応用1問）
- 採点機能、解説表示
- 結果をlocalStorageに保存
- 章カードに点数バッジ表示
- ポップアップ内スクロール改善
- 確認テストボタンを最下部に配置

### v1.16: チャットボット（未完成）
- UI実装済み（右下に常駐ボタン、チャット画面）
- フロントエンド機能実装済み
- **問題**: Claude APIを直接呼び出すとセキュリティ上NG
- **対策必要**: バックエンドAPI経由での実装

---

## 🚧 これからやること

### チャットボットのバックエンド実装

#### 1. 技術スタック
- **フロントエンド**: HTML + React (CDN)
- **バックエンド**: Vercel Serverless Functions
- **API**: Anthropic Claude API (Sonnet 4)
- **デプロイ**: Vercel

#### 2. 実装内容

##### バックエンドAPI (`/api/chat.js`)
```javascript
// POST /api/chat
// Body: { messages: [...], progress: {...}, quizResults: {...} }
// Response: { message: "..." }
```

**役割:**
- Claude APIへのリクエスト代理（APIキーを隠蔽）
- システムプロンプト生成
  - 学習進捗情報
  - 全46章のカリキュラム
  - 確認テスト結果
- エラーハンドリング

##### フロントエンド修正 (`index.html`)
- APIエンドポイントを `/api/chat` に変更
- リクエストボディに `progress` と `quizResults` を含める

#### 3. 環境変数
```
ANTHROPIC_API_KEY=sk-ant-...
```

#### 4. デプロイ設定 (`vercel.json`)
- APIルーティング設定
- CORS設定

---

## 📁 ファイル構成

```
rikanavi/
├── index.html              # フロントエンド（v1.16ベース）
├── api/
│   └── chat.js            # Claude API呼び出し
├── vercel.json            # Vercel設定
├── .env.local             # 環境変数（Git除外）
├── .env.example           # 環境変数テンプレート
├── .gitignore             # Git除外設定
├── README.md              # セットアップ手順
├── HANDOFF.md             # このファイル（引継ぎドキュメント）
└── docs/
    └── development.md     # 開発履歴
```

---

## 🎯 チャットボットの仕様

### 役割
1. **学習ガイド**: 「教科書P.20まで進んだ」→ 該当章を提案
2. **質問応答**: 理科に関する質問に答える
3. **学習提案**: 完了状況から次に学ぶべき内容を提案
4. **興味探求**: 生徒の興味に応じた対話

### システムプロンプト要件
```
あなたは中学理科の学習ガイド「りかナビ先生」です。

【学習進捗】
完了済みの章: [リスト]
確認テスト結果: [章ID: 点数]

【全カリキュラム】
[46章の一覧]

【会話のコツ】
- 親しみやすく、絵文字も使う
- 3-5行程度の回答
- りかナビの機能を勧める
```

### UI仕様
- 右下に常駐する紫色の丸ボタン（💬 学習ガイド）
- クリックで展開（380×500px）
- ヘッダー: 「🤖 りかナビ先生」
- メッセージ履歴（スクロール可能）
- 入力欄 + 送信ボタン
- 「🗑️ 会話をリセット」ボタン
- 会話履歴はlocalStorageに保存

---

## 🔑 必要な準備

### 1. Anthropic APIキーの取得
1. https://console.anthropic.com/ にアクセス
2. アカウント作成・ログイン
3. API Keysセクションで新しいキーを作成
4. `sk-ant-...` で始まるキーをコピー

### 2. Vercelアカウント
1. https://vercel.com/ にアクセス
2. GitHubアカウントでログイン

---

## 📝 Claude Codeでの作業手順

### Step 1: プロジェクトセットアップ
```bash
cd /path/to/rikanavi
npm init -y  # package.json作成（オプション）
```

### Step 2: 環境変数設定
```bash
cp .env.example .env.local
# .env.local を編集してAPIキーを設定
```

### Step 3: ローカルテスト
```bash
vercel dev
```
→ http://localhost:3000 で確認

### Step 4: デプロイ
```bash
vercel
```

---

## 🐛 既知の問題と対処

### 問題1: ローカルファイル（file://）でAPIが動かない
**原因**: ブラウザのセキュリティ制限  
**解決**: Webサーバー経由で開く（Vercelデプロイで解決）

### 問題2: APIキーの露出
**原因**: フロントエンドから直接Claude APIを呼ぶ  
**解決**: バックエンドAPI経由に変更（今回実装）

---

## 📊 データソース

- **教科書LOD**: https://jp-textbook.github.io/
- **学習指導要領LOD**: https://jp-cos.github.io/
- **NHK for School API**: https://school-api-portal.nhk.or.jp/

**使用教科書**: 新しい科学（東京書籍）2020年検定

---

## 🎓 今後の拡張案（オプション）

- [ ] 学習履歴の可視化（グラフ表示）
- [ ] 推奨学習順序の自動生成
- [ ] 間違えた問題の復習機能
- [ ] 学習時間の記録
- [ ] 保護者向けダッシュボード
- [ ] 他教科への展開

---

## 📞 連絡先・リポジトリ

- **作成者**: Masa
- **プロジェクト**: りかナビ
- **用途**: LODチャレンジ2025応募作品

---

## ✨ Claude Codeへの依頼内容

以下を実装してください：

1. **`api/chat.js` の作成**
   - Claude API（Sonnet 4）を呼び出すサーバーレス関数
   - 環境変数からAPIキーを取得
   - システムプロンプトの動的生成
   - エラーハンドリング

2. **`index.html` の修正**
   - `sendMessage` 関数のAPIエンドポイントを `/api/chat` に変更
   - リクエストボディに `progress` と `quizResults` を追加

3. **`vercel.json` の作成**
   - APIルーティング設定

4. **`.env.example` の作成**
   - 環境変数のテンプレート

5. **動作確認**
   - `vercel dev` でローカルテスト
   - チャットボットが正常に動作することを確認

**現在のファイル**: `index.html` は既に提供済み（v1.16ベース）

よろしくお願いします！
